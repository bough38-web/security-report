import csv, json

input_filename = "data.csv"
output_filename = "index.html"

news_data = []

try:
    with open(input_filename, mode="r", encoding="utf-8-sig") as f:
        reader = csv.DictReader(f)
        if reader.fieldnames:
            reader.fieldnames = [h.strip() for h in reader.fieldnames]

        for row in reader:
            title = row.get("title", "").strip()
            if not title:
                continue

            link = row.get("link", "").strip()
            if link and not link.startswith("http") and link != "#":
                link = "https://" + link
            if not link:
                link = "#"

            date = row.get("date_fmt", "").strip() or row.get("date", "").strip()
            risk = row.get("risk", "GREEN").strip().upper()
            if risk not in ["RED", "AMBER", "GREEN"]:
                risk = "GREEN"

            news_data.append({
                "keyword": row.get("keyword", "").strip(),
                "title": title,
                "link": link,
                "date": date,
                "risk": risk
            })
except FileNotFoundError:
    pass

json_payload = json.dumps(news_data, ensure_ascii=False)

html = """
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Security Insight</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">

<div class="max-w-7xl mx-auto p-6">
  <div class="bg-slate-900 text-white rounded-xl p-6 mb-6">
    <h2 class="text-lg font-bold mb-2">AI 인사이트</h2>
    <p>
      현재 <strong>__COUNT__건</strong>의 데이터가 로드되었습니다.
      <span class="text-red-400 font-bold">RED</span> 이슈는 즉시 확인하세요.
    </p>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded border">
      <p>Total</p><p id="kpi-total">-</p>
    </div>
    <div class="bg-white p-4 rounded border text-red-600">
      <p>Critical</p><p id="kpi-red">-</p>
    </div>
    <div class="bg-white p-4 rounded border text-amber-600">
      <p>Warning</p><p id="kpi-amber">-</p>
    </div>
    <div class="bg-white p-4 rounded border text-green-600">
      <p>Top Keyword</p><p id="kpi-keyword">-</p>
    </div>
  </div>

  <div id="news-list" class="space-y-3"></div>
</div>

<script>
const rawData = __DATA__;

document.getElementById("kpi-total").textContent = rawData.length;
document.getElementById("kpi-red").textContent = rawData.filter(d=>d.risk==="RED").length;
document.getElementById("kpi-amber").textContent = rawData.filter(d=>d.risk==="AMBER").length;

if(rawData.length){
  const c={};
  rawData.forEach(d=>c[d.keyword]=(c[d.keyword]||0)+1);
  document.getElementById("kpi-keyword").textContent =
    Object.entries(c).sort((a,b)=>b[1]-a[1])[0][0];
}

const list=document.getElementById("news-list");
rawData.forEach(item=>{
  const el=document.createElement("a");
  el.href=item.link;
  el.target="_blank";
  el.className="block bg-white border rounded p-4";
  el.innerHTML =
    "<strong>"+item.title+"</strong><br>" +
    "<span>"+item.keyword+" · "+item.date+" · "+item.risk+"</span>";
  list.appendChild(el);
});
</script>

</body>
</html>
"""

html = html.replace("__DATA__", json_payload)
html = html.replace("__COUNT__", str(len(news_data)))

with open(output_filename, "w", encoding="utf-8") as f:
    f.write(html)

print("index.html 생성 완료")
