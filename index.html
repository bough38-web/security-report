import requests
from bs4 import BeautifulSoup
import json
import datetime
import random
import os
import base64

# --------------------------------------------------------------------------------
# [1] ì„¤ì • ë° í¬ë¡¤ë§ ë¡œì§ (ì‚¬ìš©ìë¶„ ì½”ë“œ ê¸°ë°˜ + ì•ˆì „ì¥ì¹˜)
# --------------------------------------------------------------------------------
KEYWORDS = ["KTí…”ë ˆìº…", "SKì‰´ë”ìŠ¤", "ì—ìŠ¤ì›", "ë³´ì•ˆ ì‚¬ê³ ", "í•´í‚¹", "ê°œì¸ì •ë³´ ìœ ì¶œ", "ì‚°ì—… ì¬í•´"]
OUTPUT_FILENAME = "index.html"

def get_risk(title):
    """ì œëª©ì„ ë¶„ì„í•˜ì—¬ ìœ„í—˜ë„(Red/Amber/Green)ë¥¼ íŒë³„"""
    t = title.lower()
    if any(x in t for x in ['ì‚¬ë§', 'ìœ ì¶œ', 'í•´í‚¹', 'í™”ì¬', 'êµ¬ì†', 'ê¸´ê¸‰', 'ë§ˆë¹„']): return 'RED'
    if any(x in t for x in ['ì£¼ì˜', 'ì˜¤ë¥˜', 'ì ê²€', 'ì·¨ì•½', 'ê²°í•¨', 'ê²½ê³ ']): return 'AMBER'
    return 'GREEN'

def crawl_naver():
    print("ğŸ•·ï¸ í¬ë¡¤ë§ ë° AI ë¶„ì„ ì‹œì‘...")
    results = []
    # ë´‡ ì°¨ë‹¨ ë°©ì§€ìš© í—¤ë”
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36"
    }
    
    for kw in KEYWORDS:
        try:
            print(f"   - ê²€ìƒ‰ ì¤‘: {kw}")
            url = f"https://search.naver.com/search.naver?where=news&query={kw}&sort=1"
            res = requests.get(url, headers=headers, timeout=5)
            soup = BeautifulSoup(res.text, "html.parser")
            
            # ë‰´ìŠ¤ ì•„ì´í…œ ì¶”ì¶œ
            items = soup.select("a.news_tit")
            for item in items[:3]: # í‚¤ì›Œë“œ ë‹¹ 3ê°œ
                title = item.get_text()
                link = item['href']
                
                # ë§í¬ ê²€ì¦
                if not link.startswith("http"): link = "#"

                results.append({
                    "keyword": kw,
                    "title": title,
                    "link": link,
                    "date": datetime.datetime.now().strftime("%Y-%m-%d"),
                    "risk": get_risk(title)
                })
        except Exception as e:
            print(f"   âš ï¸ ì˜¤ë¥˜ ë°œìƒ ({kw}): {e}")
            pass
    
    # í¬ë¡¤ë§ ì‹¤íŒ¨ ì‹œ ë¹„ìƒìš© ë°ì´í„° ë¦¬í„´
    return results if results else get_dummy_data()

def get_dummy_data():
    print("ğŸš‘ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨ -> ë¹„ìƒìš© ë°ì´í„° ìƒì„±")
    return [{"keyword": k, "title": f"[{k}] ì‹œìŠ¤í…œ ì ê²€ ì¤‘ì…ë‹ˆë‹¤ (ìƒ˜í”Œ ë°ì´í„°)", "link": "#", "date": "2025-01-01", "risk": "GREEN"} for k in KEYWORDS]

# --------------------------------------------------------------------------------
# [2] ë°ì´í„° ì²˜ë¦¬ ë° ì¸ì½”ë”© (ê¹¨ì§ ë°©ì§€ í•µì‹¬ ê¸°ìˆ )
# --------------------------------------------------------------------------------
final_data = crawl_naver()

# â˜… í•µì‹¬: JSONì„ Base64 ë¬¸ìì—´ë¡œ ë³€í™˜ (íŠ¹ìˆ˜ë¬¸ì, ì¤„ë°”ê¿ˆìœ¼ë¡œ ì¸í•œ HTML ê¹¨ì§ ì›ì²œ ì°¨ë‹¨)
json_str = json.dumps(final_data, ensure_ascii=False)
b64_data = base64.b64encode(json_str.encode('utf-8')).decode('utf-8')

# ìƒë‹¨ í‚¤ì›Œë“œ ë²„íŠ¼ìš© ë°ì´í„°
kw_str = json.dumps(KEYWORDS[:6], ensure_ascii=False)
b64_kw = base64.b64encode(kw_str.encode('utf-8')).decode('utf-8')

print(f"âœ… ì´ {len(final_data)}ê±´ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ. HTML ìƒì„± ì¤‘...")

# --------------------------------------------------------------------------------
# [3] HTML í…œí”Œë¦¿ (ì „ë¬¸ê°€ìš© ë””ìì¸ + Base64 ë””ì½”ë” ë‚´ì¥)
# --------------------------------------------------------------------------------
# f-stringì„ ì“°ì§€ ì•Šê³  ì¼ë°˜ ë¬¸ìì—´ë¡œ ì‘ì„±í•˜ì—¬ JS/CSS ì¶©ëŒ ë°©ì§€
html_template = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Security Watch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .glass-card:hover { transform: translateY(-2px); transition: all 0.2s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
        .badge { padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-RED { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
        .badge-AMBER { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
        .badge-GREEN { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        #loader { position: fixed; inset: 0; background: white; z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 font-bold">ë³´ì•ˆ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
    </div>

    <nav class="bg-slate-900 text-white h-14 sticky top-0 z-40 px-6 flex items-center justify-between shadow-md">
        <div class="flex items-center gap-2 font-bold text-lg">
            <i class="ph-fill ph-shield-check text-blue-400"></i> AI Security Watch
        </div>
        <div class="text-xs bg-slate-800 px-3 py-1 rounded-full text-slate-300 border border-slate-700">
            Live Auto-Crawl
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 space-y-6">
        
        <div class="glass-card p-6 bg-gradient-to-r from-slate-800 to-slate-900 text-white border-none">
            <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="ph-duotone ph-robot"></i> AI Risk Analysis</h2>
            <p id="ai-msg" class="text-sm text-slate-300 bg-white/10 p-3 rounded-lg backdrop-blur-sm">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            <div id="quick-btns" class="mt-4 flex flex-wrap gap-2"></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass-card p-5 border-l-4 border-blue-500">
                <p class="text-xs text-slate-500 font-bold uppercase">Total</p>
                <h3 id="kpi-total" class="text-2xl font-bold text-slate-800 mt-1">-</h3>
            </div>
            <div class="glass-card p-5 border-l-4 border-red-500 bg-red-50/10">
                <p class="text-xs text-red-600 font-bold uppercase">Critical</p>
                <h3 id="kpi-red" class="text-2xl font-bold text-red-600 mt-1">-</h3>
            </div>
            <div class="glass-card p-5 border-l-4 border-amber-500">
                <p class="text-xs text-amber-600 font-bold uppercase">Warning</p>
                <h3 id="kpi-amber" class="text-2xl font-bold text-amber-600 mt-1">-</h3>
            </div>
            <div class="glass-card p-5 border-l-4 border-green-500">
                <p class="text-xs text-green-600 font-bold uppercase">Keyword</p>
                <h3 id="kpi-kw" class="text-lg font-bold text-green-700 mt-2 truncate">-</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-6">
                <div class="glass-card p-5 sticky top-20">
                    <h3 class="font-bold text-sm text-slate-700 mb-3 border-b pb-2">Control Panel</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 block mb-1">í‚¤ì›Œë“œ</label>
                            <select id="sel-kw" class="w-full border p-2 rounded text-sm bg-slate-50 outline-none focus:border-blue-500"><option value="all">ì „ì²´ ë³´ê¸°</option></select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 block mb-1">ê²€ìƒ‰</label>
                            <input id="inp-search" type="text" class="w-full border p-2 rounded text-sm bg-slate-50 outline-none focus:border-blue-500" placeholder="ì œëª© ê²€ìƒ‰...">
                        </div>
                    </div>
                </div>
                <div class="glass-card p-5">
                    <h3 class="font-bold text-sm text-slate-700 mb-3">Risk Share</h3>
                    <div class="h-48 relative"><canvas id="chart"></canvas></div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex justify-between items-end mb-3 px-1">
                    <h3 class="font-bold text-lg text-slate-800">News Feed</h3>
                    <span id="cnt" class="text-xs font-bold bg-white border px-2 py-1 rounded text-slate-500 shadow-sm">0ê±´</span>
                </div>
                <div id="list" class="space-y-3"></div>
            </div>
        </div>
        
        <footer class="mt-12 py-8 text-center text-xs text-slate-400 border-t">
            &copy; 2025 AI Security Watch. Auto-Generated Dashboard.
        </footer>
    </div>

    <script>
        // â˜… Base64 ë°ì´í„° ìˆ˜ì‹  (ê¹¨ì§ ë°©ì§€)
        const b64Data = "__DATA_B64__";
        const b64Kw = "__KW_B64__";
        
        let rawData = [];
        let keywords = [];
        let filtered = [];
        let myChart = null;

        // Base64 ë””ì½”ë”© (í•œê¸€ ì™„ë²½ ì§€ì›)
        function decodeData(b64) {
            try {
                const binString = atob(b64);
                const bytes = Uint8Array.from(binString, m => m.codePointAt(0));
                return JSON.parse(new TextDecoder().decode(bytes));
            } catch (e) {
                console.error("ë””ì½”ë”© ì‹¤íŒ¨:", e);
                return [];
            }
        }

        window.onload = () => {
            // ë°ì´í„° ë””ì½”ë”©
            rawData = decodeData(b64Data);
            keywords = decodeData(b64Kw);
            filtered = [...rawData];

            // ë¡œë”© ì œê±° (ì•ˆì „ì¥ì¹˜)
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
            }, 500);
            
            init();
        };

        function init() {
            const btnArea = document.getElementById('quick-btns');
            const sel = document.getElementById('sel-kw');
            
            // í‚¤ì›Œë“œ ë²„íŠ¼ ë° ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìƒì„±
            keywords.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = k;
                sel.appendChild(opt);
                
                const btn = document.createElement('button');
                btn.className = "px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-700 text-slate-300 hover:bg-blue-500 hover:text-white transition-colors border border-slate-600";
                btn.textContent = k;
                btn.onclick = () => { sel.value = k; update(); };
                btnArea.appendChild(btn);
            });

            update();
        }

        function update() {
            const kw = document.getElementById('sel-kw').value;
            const search = document.getElementById('inp-search').value.toLowerCase();

            filtered = rawData.filter(d => {
                return (kw === 'all' || d.keyword === kw) && d.title.toLowerCase().includes(search);
            });

            render();
        }

        function render() {
            // KPI ì—…ë°ì´íŠ¸
            document.getElementById('kpi-total').textContent = filtered.length;
            const red = filtered.filter(d=>d.risk==='RED').length;
            document.getElementById('kpi-red').textContent = red;
            document.getElementById('kpi-amber').textContent = filtered.filter(d=>d.risk==='AMBER').length;
            
            if(filtered.length > 0) {
                const c = {};
                filtered.forEach(d=>c[d.keyword]=(c[d.keyword]||0)+1);
                const top = Object.keys(c).reduce((a,b)=>c[a]>c[b]?a:b);
                document.getElementById('kpi-kw').textContent = top;
            } else {
                document.getElementById('kpi-kw').textContent = "-";
            }

            // AI ìš”ì•½
            const msg = document.getElementById('ai-msg');
            if(red > 0) {
                msg.innerHTML = `í˜„ì¬ <span class="text-red-400 font-bold">ì‹¬ê°(Critical) ì´ìŠˆê°€ ${red}ê±´</span> ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
            } else {
                msg.innerHTML = `ë¶„ì„ ê²°ê³¼, í˜„ì¬ íŠ¹ì´í•œ ë³´ì•ˆ ìœ„í˜‘ ì§•í›„ëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì•ˆì „ ìƒíƒœ)`;
            }

            // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            const list = document.getElementById('list');
            list.innerHTML = '';
            document.getElementById('cnt').textContent = `${filtered.length}ê±´`;

            if(filtered.length === 0) {
                list.innerHTML = '<div class="p-8 text-center border-2 border-dashed border-slate-200 rounded-lg text-slate-400">ë°ì´í„° ì—†ìŒ</div>';
            } else {
                filtered.forEach(d => {
                    const el = document.createElement('a');
                    el.href = d.link; el.target = "_blank";
                    el.className = "block glass-card p-5 group no-underline relative hover:border-blue-400 transition-all";
                    const badge = `badge-${d.risk}`;
                    el.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1">
                                <div class="flex gap-2 mb-2 items-center flex-wrap">
                                    <span class="badge ${badge}">${d.risk}</span>
                                    <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200 font-bold">${d.keyword}</span>
                                    <span class="text-xs text-slate-400 font-mono">${d.date}</span>
                                </div>
                                <div class="font-bold text-slate-800 text-base leading-snug group-hover:text-blue-600 transition-colors">
                                    ${d.title}
                                </div>
                            </div>
                            <i class="ph-bold ph-arrow-square-out text-slate-300 text-lg group-hover:text-blue-500"></i>
                        </div>
                    `;
                    list.appendChild(el);
                });
            }

            // ì°¨íŠ¸ ë Œë”ë§
            if(myChart) myChart.destroy();
            const counts = {RED:0, AMBER:0, GREEN:0};
            filtered.forEach(d => {
                if(counts[d.risk]!==undefined) counts[d.risk]++;
                else counts.GREEN++;
            });

            const ctx = document.getElementById('chart');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'Warning', 'Safe'],
                    datasets: [{
                        data: [counts.RED, counts.AMBER, counts.GREEN],
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%', 
                    plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } } 
                }
            });
        }

        document.getElementById('sel-kw').addEventListener('change', update);
        document.getElementById('inp-search').addEventListener('input', update);
    </script>
</body>
</html>
"""

# --- [4] ë°ì´í„° ì£¼ì… (Replace ë°©ì‹) ---
# ì•”í˜¸í™”ëœ ë°ì´í„°ë¥¼ HTMLì— ì‹¬ìŠµë‹ˆë‹¤.
final_html = html_template.replace("__DATA_B64__", b64_data)
final_html = final_html.replace("__KW_B64__", b64_kw)

# íŒŒì¼ ì €ì¥
with open(OUTPUT_FILENAME, 'w', encoding='utf-8') as f:
    f.write(final_html)

print(f"âœ¨ ì™„ë£Œ! '{OUTPUT_FILENAME}' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("1. ì´ íŒŒì¼ì„ ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œí•˜ì„¸ìš”.")
print("2. ë°ì´í„°ê°€ Base64ë¡œ ë³´í˜¸ë˜ì–´ ìˆì–´ ê¸€ìê°€ ê¹¨ì§€ê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
