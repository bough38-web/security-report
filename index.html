import json
import datetime
import random
import time
import os

# --- [ì„¤ì •] í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ---
KEYWORDS = ["KTí…”ë ˆìº…", "SKì‰´ë”ìŠ¤", "ì—ìŠ¤ì›", "ë³´ì•ˆ ì‚¬ê³ ", "í•´í‚¹", "ê°œì¸ì •ë³´ ìœ ì¶œ", "ì‚°ì—… ì¬í•´"]
OUTPUT_FILENAME = "index.html"

# --- [1] ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ ---
try:
    import requests
    from bs4 import BeautifulSoup
    print("âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬(requests, bs4)ê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
except ImportError:
    print("âŒ ì˜¤ë¥˜: 'requests'ì™€ 'beautifulsoup4' ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
    print("   í„°ë¯¸ë„ì— ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”: pip install requests beautifulsoup4")
    # ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ì–´ë„ ì‘ë™í•˜ë„ë¡ ê°€ì§œ ëª¨ë“ˆ ìƒì„± (ì‹¤í–‰ ì¤‘ë‹¨ ë°©ì§€)
    requests = None
    BeautifulSoup = None

# --- [2] AI ìœ„í—˜ë„ ë¶„ì„ (Rule-based) ---
def analyze_risk(title):
    t = title.lower()
    if any(k in t for k in ['ì‚¬ë§', 'ìœ ì¶œ', 'í•´í‚¹', 'êµ¬ì†', 'ê¸´ê¸‰', 'ë§ˆë¹„', 'í™”ì¬', 'ì¶©ëŒ']):
        return "RED"
    elif any(k in t for k in ['ì£¼ì˜', 'ìš°ë ¤', 'ê²½ê³ ', 'ì·¨ì•½', 'ì˜¤ë¥˜', 'ì ê²€', 'ë¹„ìƒ']):
        return "AMBER"
    return "GREEN"

# --- [3] ê°•ë ¥í•œ ë„¤ì´ë²„ ë‰´ìŠ¤ í¬ë¡¤ëŸ¬ ---
def crawl_naver(keywords):
    if not requests:
        return [] # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë¦¬í„´

    results = []
    # â˜… í•µì‹¬: ë´‡ íƒì§€ë¥¼ í”¼í•˜ê¸° ìœ„í•œ í—¤ë” (ì‚¬ëŒì¸ ì²™ ìœ„ì¥)
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
    }

    print("\nğŸ•·ï¸ í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    
    for kw in keywords:
        try:
            url = f"https://search.naver.com/search.naver?where=news&query={kw}&sort=1"
            res = requests.get(url, headers=headers, timeout=5)
            
            if res.status_code != 200:
                print(f"   âš ï¸ [{kw}] ì ‘ì† ì‹¤íŒ¨ (ìƒíƒœì½”ë“œ: {res.status_code})")
                continue

            soup = BeautifulSoup(res.text, "html.parser")
            news_items = soup.select("a.news_tit") # ë‰´ìŠ¤ ì œëª© íƒœê·¸

            if not news_items:
                print(f"   âš ï¸ [{kw}] ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ (ë„¤ì´ë²„ êµ¬ì¡° ë³€ê²½ ë˜ëŠ” ì°¨ë‹¨ë¨)")
                continue

            count = 0
            for item in news_items[:3]: # í‚¤ì›Œë“œ ë‹¹ 3ê°œë§Œ
                title = item.get_text()
                link = item['href']
                
                results.append({
                    "keyword": kw,
                    "title": title,
                    "link": link,
                    "date": datetime.datetime.now().strftime("%Y-%m-%d"),
                    "risk": analyze_risk(title)
                })
                count += 1
            
            print(f"   âœ… [{kw}] {count}ê±´ ìˆ˜ì§‘ ì™„ë£Œ")
            time.sleep(0.5) # ì°¨ë‹¨ ë°©ì§€ìš© ë”œë ˆì´

        except Exception as e:
            print(f"   âŒ [{kw}] ì—ëŸ¬ ë°œìƒ: {e}")

    return results

# --- [4] ë¹„ìƒìš© ë°ì´í„° (í¬ë¡¤ë§ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©) ---
def get_fallback_data():
    print("\nğŸš‘ í¬ë¡¤ë§ì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ë°ì´í„°ê°€ ì—†ì–´ 'í…ŒìŠ¤íŠ¸ ë°ì´í„°'ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
    dummy = []
    for k in KEYWORDS:
        dummy.append({
            "keyword": k,
            "title": f"[{k}] (í…ŒìŠ¤íŠ¸ìš©) ìµœì‹  ë³´ì•ˆ ì´ìŠˆ ëª¨ë‹ˆí„°ë§ ìƒ˜í”Œ ê¸°ì‚¬ì…ë‹ˆë‹¤.",
            "link": "#",
            "date": datetime.datetime.now().strftime("%Y-%m-%d"),
            "risk": random.choice(["RED", "GREEN"])
        })
    return dummy

# ==========================================
# [ì‹¤í–‰ ë¡œì§]
# ==========================================

# 1. í¬ë¡¤ë§ ì‹œë„
final_data = crawl_naver(KEYWORDS)

# 2. ì‹¤íŒ¨ ì‹œ ë¹„ìƒìš© ë°ì´í„° ì‚¬ìš©
if not final_data:
    final_data = get_fallback_data()

# 3. JSON ë³€í™˜ (HTML ì£¼ì…ìš©)
json_payload = json.dumps(final_data, ensure_ascii=False)
keyword_list_json = json.dumps(KEYWORDS[:6], ensure_ascii=False) # ìƒë‹¨ ë²„íŠ¼ìš©

print(f"\nğŸ“Š ìµœì¢… ë°ì´í„°: {len(final_data)}ê±´ ì¤€ë¹„ë¨.")

# 4. HTML ìƒì„± (ë°ì´í„° ì§ì ‘ ì£¼ì… ë°©ì‹ - ì—ëŸ¬ ì—†ìŒ)
html_content = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Security Watch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {{ font-family: system-ui, sans-serif; background: #f8fafc; }}
        .glass-card {{ background: white; border: 1px solid #e2e8f0; border-radius: 12px; }}
        .glass-card:hover {{ transform: translateY(-2px); transition: 0.2s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }}
        .badge {{ padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }}
        .badge-RED {{ background: #fef2f2; color: #dc2626; border: 1px solid #fca5a5; }}
        .badge-AMBER {{ background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }}
        .badge-GREEN {{ background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }}
    </style>
</head>
<body>
    <nav class="bg-slate-900 text-white h-14 sticky top-0 z-50 flex items-center px-6 justify-between shadow-lg">
        <div class="flex items-center gap-2 font-bold text-lg">
            <i class="ph-fill ph-robot text-blue-400"></i> AI Security Watch
        </div>
        <div class="text-xs bg-slate-800 px-3 py-1 rounded-full text-slate-300">Live Auto-Crawl</div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 space-y-6">
        
        <div class="glass-card p-6 bg-gradient-to-r from-slate-800 to-slate-900 text-white border-none">
            <h2 class="font-bold text-lg mb-2">ğŸ’¡ AI Risk Analysis</h2>
            <p id="ai-msg" class="text-sm text-slate-300 bg-white/10 p-3 rounded-lg">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            <div id="quick-btns" class="mt-4 flex flex-wrap gap-2"></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass-card p-4 border-l-4 border-blue-500">
                <p class="text-xs text-slate-500 font-bold">Total</p>
                <h3 id="kpi-total" class="text-2xl font-bold text-slate-800">-</h3>
            </div>
            <div class="glass-card p-4 border-l-4 border-red-500">
                <p class="text-xs text-red-600 font-bold">Critical</p>
                <h3 id="kpi-red" class="text-2xl font-bold text-red-600">-</h3>
            </div>
            <div class="glass-card p-4 border-l-4 border-amber-500">
                <p class="text-xs text-amber-600 font-bold">Warning</p>
                <h3 id="kpi-amber" class="text-2xl font-bold text-amber-600">-</h3>
            </div>
            <div class="glass-card p-4 border-l-4 border-green-500">
                <p class="text-xs text-green-600 font-bold">Top Keyword</p>
                <h3 id="kpi-kw" class="text-lg font-bold text-green-700 truncate">-</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-6">
                <div class="glass-card p-5 sticky top-20">
                    <h3 class="font-bold text-sm mb-3">Filter</h3>
                    <select id="sel-kw" class="w-full border p-2 rounded text-sm mb-2"><option value="all">ì „ì²´ í‚¤ì›Œë“œ</option></select>
                    <input id="inp-search" type="text" class="w-full border p-2 rounded text-sm" placeholder="ê²€ìƒ‰...">
                </div>
                <div class="glass-card p-5">
                    <h3 class="font-bold text-sm mb-3">Risk Share</h3>
                    <div class="h-40"><canvas id="chart"></canvas></div>
                </div>
            </div>
            <div class="lg:col-span-2">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-lg">News Feed</h3>
                    <span id="cnt" class="text-xs font-bold text-slate-500">0 results</span>
                </div>
                <div id="list" class="space-y-3"></div>
            </div>
        </div>
        
        <footer class="mt-10 text-center text-xs text-slate-400 py-6 border-t">
            Auto-Generated by Python Crawler
        </footer>
    </div>

    <script>
        // â˜… ë°ì´í„° ì§ì ‘ ì£¼ì… (ì•ˆì „ì¥ì¹˜)
        const rawData = {json_payload};
        const keywords = {keyword_list_json};
        
        let filtered = [...rawData];
        let myChart = null;

        // ì‹¤í–‰
        window.onload = () => {{
            init();
        }};

        function init() {{
            // ë²„íŠ¼ ë° ì…€ë ‰íŠ¸ ìƒì„±
            const btnArea = document.getElementById('quick-btns');
            const sel = document.getElementById('sel-kw');
            
            keywords.forEach(k => {{
                // ì…€ë ‰íŠ¸
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = k;
                sel.appendChild(opt);
                // ë²„íŠ¼
                const btn = document.createElement('button');
                btn.className = "px-3 py-1 rounded text-xs font-bold bg-slate-700 hover:bg-blue-600 transition text-white";
                btn.textContent = k;
                btn.onclick = () => {{ sel.value = k; update(); }};
                btnArea.appendChild(btn);
            }});

            update();
        }}

        function update() {{
            const kw = document.getElementById('sel-kw').value;
            const search = document.getElementById('inp-search').value.toLowerCase();

            filtered = rawData.filter(d => {{
                return (kw === 'all' || d.keyword === kw) && d.title.toLowerCase().includes(search);
            }});

            render();
        }}

        function render() {{
            // KPI
            document.getElementById('kpi-total').textContent = filtered.length;
            const red = filtered.filter(d=>d.risk==='RED').length;
            document.getElementById('kpi-red').textContent = red;
            document.getElementById('kpi-amber').textContent = filtered.filter(d=>d.risk==='AMBER').length;
            
            // Keyword
            if(filtered.length>0) {{
                const c = {{}};
                filtered.forEach(d=>c[d.keyword]=(c[d.keyword]||0)+1);
                document.getElementById('kpi-kw').textContent = Object.keys(c).reduce((a,b)=>c[a]>c[b]?a:b);
            }} else {{
                document.getElementById('kpi-kw').textContent = "-";
            }}

            // AI Summary
            const summary = document.getElementById('ai-msg');
            if(red > 0) {{
                summary.innerHTML = `í˜„ì¬ <span class="text-red-400 font-bold">ì‹¬ê°(Critical) ì´ìŠˆê°€ ${{red}}ê±´</span> ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
            }} else {{
                summary.innerHTML = `ë¶„ì„ ê²°ê³¼, í˜„ì¬ íŠ¹ì´í•œ ë³´ì•ˆ ìœ„í˜‘ ì§•í›„ëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì•ˆì „)`;
            }}

            // List
            const list = document.getElementById('list');
            list.innerHTML = '';
            document.getElementById('cnt').textContent = `${{filtered.length}} results`;

            if(filtered.length === 0) {{
                list.innerHTML = '<div class="p-5 text-center border rounded text-slate-400">ë°ì´í„° ì—†ìŒ</div>';
            }} else {{
                filtered.forEach(d => {{
                    const el = document.createElement('a');
                    el.href = d.link; el.target = "_blank";
                    el.className = "block glass-card p-4 hover:border-blue-400 group";
                    const badge = `badge-${{d.risk}}`;
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex gap-2 mb-1 items-center">
                                    <span class="badge ${{badge}}">${{d.risk}}</span>
                                    <span class="text-xs text-slate-500 font-bold">[${{d.keyword}}]</span>
                                    <span class="text-xs text-slate-400">${{d.date}}</span>
                                </div>
                                <div class="font-bold text-slate-800 group-hover:text-blue-600">${{d.title}}</div>
                            </div>
                            <i class="ph-bold ph-arrow-square-out text-slate-300"></i>
                        </div>
                    `;
                    list.appendChild(el);
                }});
            }}

            // Chart
            if(myChart) myChart.destroy();
            const counts = {{RED:0, AMBER:0, GREEN:0}};
            filtered.forEach(d => {{
                if(counts[d.risk]!==undefined) counts[d.risk]++;
                else counts.GREEN++;
            }});

            const ctx = document.getElementById('chart');
            myChart = new Chart(ctx, {{
                type: 'doughnut',
                data: {{
                    labels: ['Critical', 'Warning', 'Safe'],
                    datasets: [{{
                        data: [counts.RED, counts.AMBER, counts.GREEN],
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                        borderWidth: 0
                    }}]
                }},
                options: {{ cutout: '70%', plugins: {{ legend: {{ position: 'right', labels: {{ boxWidth: 10 }} }} }} }}
            }});
        }}

        // ë¦¬ìŠ¤ë„ˆ
        document.getElementById('sel-kw').addEventListener('change', update);
        document.getElementById('inp-search').addEventListener('input', update);
    </script>
</body>
</html>
"""

# íŒŒì¼ ì €ì¥
with open(OUTPUT_FILENAME, 'w', encoding='utf-8') as f:
    f.write(html_content)

print(f"\nâœ¨ ìƒì„± ì™„ë£Œ! '{OUTPUT_FILENAME}' íŒŒì¼ì„ ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œí•˜ì„¸ìš”.")
