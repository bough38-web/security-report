import json
import datetime
import random
import os
import base64
import time

# --- [ì„¤ì •] ---
KEYWORDS = ["KTí…”ë ˆìº…", "SKì‰´ë”ìŠ¤", "ì—ìŠ¤ì›", "ë³´ì•ˆ ì‚¬ê³ ", "í•´í‚¹", "ê°œì¸ì •ë³´ ìœ ì¶œ", "ì‚°ì—… ì¬í•´"]
OUTPUT_FILENAME = "index.html"

# --- [1] ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ---
try:
    import requests
    from bs4 import BeautifulSoup
    HAS_LIBS = True
    print("âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°ì§€ë¨: ì‹¤ì‹œê°„ í¬ë¡¤ë§ì„ ì‹œë„í•©ë‹ˆë‹¤.")
except ImportError:
    HAS_LIBS = False
    print("âš ï¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ: 'í…ŒìŠ¤íŠ¸ ë°ì´í„° ëª¨ë“œ'ë¡œ ì‘ë™í•©ë‹ˆë‹¤.")

# --- [2] ìœ„í—˜ë„ ë¶„ì„ ---
def get_risk(title):
    t = title.lower()
    if any(x in t for x in ['ì‚¬ë§', 'ìœ ì¶œ', 'í•´í‚¹', 'í™”ì¬', 'êµ¬ì†', 'ê¸´ê¸‰', 'ë§ˆë¹„', 'ì¶©ëŒ', 'ì ë°œ']):
        return 'RED'
    if any(x in t for x in ['ì£¼ì˜', 'ì˜¤ë¥˜', 'ì ê²€', 'ì·¨ì•½', 'ê²°í•¨', 'ê²½ê³ ', 'ë¹„ìƒ']):
        return 'AMBER'
    return 'GREEN'

# --- [3] ë°ì´í„° ìˆ˜ì§‘ (í¬ë¡¤ë§ + ì•ˆì „ì¥ì¹˜) ---
def get_data():
    if not HAS_LIBS:
        return get_dummy_data("ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸ì„¤ì¹˜ (í…ŒìŠ¤íŠ¸)")

    print("ğŸ•·ï¸ í¬ë¡¤ë§ ì‹œì‘...")
    results = []
    # ë´‡ ì°¨ë‹¨ ìš°íšŒ í—¤ë”
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36"
    }

    for kw in KEYWORDS:
        try:
            url = f"https://search.naver.com/search.naver?where=news&query={kw}&sort=1"
            res = requests.get(url, headers=headers, timeout=5)
            
            if res.status_code != 200:
                continue

            soup = BeautifulSoup(res.text, "html.parser")
            items = soup.select("a.news_tit")

            for item in items[:3]:
                title = item.get_text()
                link = item['href']
                if not link.startswith("http"): link = "#"
                
                results.append({
                    "keyword": kw,
                    "title": title,
                    "link": link,
                    "date": datetime.datetime.now().strftime("%Y-%m-%d"),
                    "risk": get_risk(title)
                })
            time.sleep(0.2) # ì°¨ë‹¨ ë°©ì§€
        except Exception as e:
            print(f"âš ï¸ {kw} ìˆ˜ì§‘ ì¤‘ ì—ëŸ¬: {e}")
    
    if not results:
        return get_dummy_data("í¬ë¡¤ë§ ë°ì´í„° ì—†ìŒ (ì°¨ë‹¨ë¨)")
        
    return results

def get_dummy_data(reason):
    print(f"ğŸš‘ {reason} -> ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
    return [{"keyword": k, "title": f"[{k}] ë³´ì•ˆ ì´ìŠˆ ëª¨ë‹ˆí„°ë§ (ìƒ˜í”Œ ë°ì´í„°)", "link": "#", "date": "2025-01-01", "risk": "GREEN"} for k in KEYWORDS]

# --- [4] ë°ì´í„° ì•”í˜¸í™” (í•µì‹¬: ê¹¨ì§ ë°©ì§€) ---
final_data = get_data()

# 1. í•œê¸€ì„ í¬í•¨í•œ ëª¨ë“  ë¬¸ìë¥¼ ASCII ì½”ë“œë¡œ ë³€í™˜ (ensure_ascii=True)
#    ì´ë ‡ê²Œ í•˜ë©´ í•œê¸€ì´ \uXXXX í˜•íƒœë¡œ ë³€í•´ì„œ ì ˆëŒ€ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
json_str = json.dumps(final_data, ensure_ascii=True)
kw_str = json.dumps(KEYWORDS, ensure_ascii=True)

# 2. Base64ë¡œ ì¸ì½”ë”©
b64_data = base64.b64encode(json_str.encode('ascii')).decode('ascii')
b64_kw = base64.b64encode(kw_str.encode('ascii')).decode('ascii')

print(f"âœ… ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ ({len(final_data)}ê±´). HTML ìƒì„± ì¤‘...")

# --- [5] HTML í…œí”Œë¦¿ (ê°€ì¥ í˜¸í™˜ì„± ë†’ì€ ì½”ë“œ) ---
html = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {{ font-family: sans-serif; background-color: #f1f5f9; }}
        .card {{ background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }}
        .card:hover {{ transform: translateY(-2px); transition: 0.2s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }}
    </style>
</head>
<body class="text-slate-800">

    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="font-bold text-slate-500">ë°ì´í„° ë¡œë”© ì¤‘...</p>
    </div>

    <nav class="bg-slate-900 text-white h-16 flex items-center px-6 justify-between shadow-lg sticky top-0 z-40">
        <div class="font-bold text-xl flex items-center gap-2">
            <i class="ph-fill ph-shield-check text-blue-400"></i> AI Security Watch
        </div>
        <span class="text-xs bg-slate-800 px-3 py-1 rounded-full text-slate-300">Live</span>
    </nav>

    <div class="max-w-7xl mx-auto p-6 space-y-6">
        
        <div class="card p-6 bg-gradient-to-r from-slate-800 to-slate-900 text-white border-none">
            <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="ph-duotone ph-robot"></i> AI Risk Analysis</h2>
            <p id="summary-text" class="text-sm text-slate-300 bg-white/10 p-3 rounded mb-4">ë¶„ì„ ì¤‘...</p>
            <div id="btn-container" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-xs font-bold text-slate-500">TOTAL</p>
                <h3 id="kpi-total" class="text-2xl font-bold">-</h3>
            </div>
            <div class="card p-5 border-l-4 border-red-500">
                <p class="text-xs font-bold text-red-500">CRITICAL</p>
                <h3 id="kpi-red" class="text-2xl font-bold text-red-600">-</h3>
            </div>
            <div class="card p-5 border-l-4 border-amber-500">
                <p class="text-xs font-bold text-amber-500">WARNING</p>
                <h3 id="kpi-amber" class="text-2xl font-bold text-amber-600">-</h3>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-xs font-bold text-green-500">KEYWORD</p>
                <h3 id="kpi-keyword" class="text-lg font-bold text-green-600 truncate">-</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-6">
                <div class="card p-5 sticky top-20">
                    <h3 class="font-bold text-sm mb-3">ê²€ìƒ‰ í•„í„°</h3>
                    <input id="search-input" type="text" class="w-full border p-2 rounded text-sm mb-3 outline-none focus:border-blue-500" placeholder="ì œëª© ê²€ìƒ‰...">
                    <select id="keyword-select" class="w-full border p-2 rounded text-sm outline-none"><option value="all">ì „ì²´ í‚¤ì›Œë“œ</option></select>
                </div>
                <div class="card p-5">
                    <h3 class="font-bold text-sm mb-3">ë¦¬ìŠ¤í¬ ë¶„í¬</h3>
                    <div class="h-48"><canvas id="myChart"></canvas></div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-lg">ë‰´ìŠ¤ í”¼ë“œ</h3>
                    <span id="list-count" class="text-xs font-bold bg-white px-2 py-1 rounded border">0ê±´</span>
                </div>
                <div id="news-list" class="space-y-3"></div>
            </div>
        </div>
        
        <footer class="mt-12 text-center text-xs text-slate-400 py-6 border-t">
            &copy; 2025 AI Security Watch. Auto-Generated.
        </footer>
    </div>

    <script>
        // â˜…â˜…â˜… ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤ â˜…â˜…â˜…
        // í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•´ Base64ë¡œ ì¸ì½”ë”©ëœ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ, ë¸Œë¼ìš°ì €ê°€ ì§ì ‘ í’‰ë‹ˆë‹¤.
        const RAW_DATA_B64 = "{b64_data}";
        const KEYWORDS_B64 = "{b64_kw}";

        let rawData = [];
        let keywords = [];
        let filteredData = [];
        let chartInstance = null;

        window.onload = function() {{
            try {{
                // 1. ë°ì´í„° ë””ì½”ë”© (atobëŠ” Base64ë¥¼ í’‰ë‹ˆë‹¤)
                rawData = JSON.parse(atob(RAW_DATA_B64));
                keywords = JSON.parse(atob(KEYWORDS_B64));
                filteredData = [...rawData];

                // 2. ì´ˆê¸°í™” ì‹¤í–‰
                init();
                
                // 3. ë¡œë”© ì œê±°
                document.getElementById('loader').style.display = 'none';
            }} catch (e) {{
                alert("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                document.getElementById('loader').style.display = 'none';
            }}
        }};

        function init() {{
            // ë²„íŠ¼ ìƒì„±
            const btnContainer = document.getElementById('btn-container');
            const select = document.getElementById('keyword-select');

            keywords.forEach(k => {{
                // ì…€ë ‰íŠ¸ ì˜µì…˜
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = k;
                select.appendChild(opt);

                // ë²„íŠ¼
                const btn = document.createElement('button');
                btn.className = "px-3 py-1 bg-slate-700 hover:bg-blue-600 text-white rounded text-xs transition-colors";
                btn.textContent = k;
                btn.onclick = () => {{ select.value = k; update(); }};
                btnContainer.appendChild(btn);
            }});

            update();
        }}

        function update() {{
            const kw = document.getElementById('keyword-select').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            filteredData = rawData.filter(item => {{
                const matchKw = kw === 'all' || item.keyword === kw;
                const matchSearch = item.title.toLowerCase().includes(search);
                return matchKw && matchSearch;
            }});

            render();
        }}

        function render() {{
            // KPI
            document.getElementById('kpi-total').textContent = filteredData.length;
            const redCount = filteredData.filter(d => d.risk === 'RED').length;
            document.getElementById('kpi-red').textContent = redCount;
            document.getElementById('kpi-amber').textContent = filteredData.filter(d => d.risk === 'AMBER').length;
            
            if (filteredData.length > 0) {{
                const counts = {{}};
                filteredData.forEach(d => counts[d.keyword] = (counts[d.keyword]||0)+1);
                document.getElementById('kpi-keyword').textContent = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);
            }} else {{
                document.getElementById('kpi-keyword').textContent = "-";
            }}

            // ìš”ì•½
            const summary = document.getElementById('summary-text');
            if (redCount > 0) {{
                summary.innerHTML = `í˜„ì¬ <span class="text-red-400 font-bold">ì‹¬ê°(Critical) ì´ìŠˆê°€ ${{redCount}}ê±´</span> ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
            }} else {{
                summary.innerHTML = "ë¶„ì„ ê²°ê³¼, íŠ¹ì´í•œ ë³´ì•ˆ ìœ„í˜‘ ì§•í›„ëŠ” ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì•ˆì „)";
            }}

            // ë¦¬ìŠ¤íŠ¸
            const list = document.getElementById('news-list');
            list.innerHTML = '';
            document.getElementById('list-count').textContent = filteredData.length + "ê±´";

            if (filteredData.length === 0) {{
                list.innerHTML = '<div class="p-8 text-center border rounded text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }} else {{
                filteredData.forEach(d => {{
                    const el = document.createElement('a');
                    el.href = d.link; el.target = "_blank";
                    el.className = "block card p-4 group no-underline";
                    
                    let badgeColor = "bg-green-100 text-green-700 border-green-200";
                    if(d.risk === "RED") badgeColor = "bg-red-100 text-red-700 border-red-200";
                    if(d.risk === "AMBER") badgeColor = "bg-amber-100 text-amber-700 border-amber-200";

                    el.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                            <div>
                                <div class="flex gap-2 mb-2 items-center flex-wrap">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold border ${{badgeColor}}">${{d.risk}}</span>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600 border">${{d.keyword}}</span>
                                    <span class="text-xs text-slate-400 font-mono">${{d.date}}</span>
                                </div>
                                <h4 class="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${{d.title}}</h4>
                            </div>
                            <i class="ph-bold ph-arrow-square-out text-slate-300 group-hover:text-blue-500"></i>
                        </div>
                    `;
                    list.appendChild(el);
                }});
            }}

            // ì°¨íŠ¸
            if(chartInstance) chartInstance.destroy();
            const rCounts = {{RED:0, AMBER:0, GREEN:0}};
            filteredData.forEach(d => {{
                if(rCounts[d.risk] !== undefined) rCounts[d.risk]++;
                else rCounts.GREEN++;
            }});

            const ctx = document.getElementById('myChart');
            chartInstance = new Chart(ctx, {{
                type: 'doughnut',
                data: {{
                    labels: ['Critical', 'Warning', 'Safe'],
                    datasets: [{{
                        data: [rCounts.RED, rCounts.AMBER, rCounts.GREEN],
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                        borderWidth: 0
                    }}]
                }},
                options: {{ cutout: '75%', plugins: {{ legend: {{ position: 'right', labels: {{ usePointStyle: true, boxWidth: 8 }} }} }} }}
            }});
        }}

        document.getElementById('keyword-select').addEventListener('change', update);
        document.getElementById('search-input').addEventListener('input', update);
    </script>
</body>
</html>
"""

# --- [6] íŒŒì¼ ì €ì¥ ---
with open(OUTPUT_FILENAME, 'w', encoding='utf-8') as f:
    f.write(html)

print(f"âœ¨ ìƒì„± ì™„ë£Œ: {OUTPUT_FILENAME}")
